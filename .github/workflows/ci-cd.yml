name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      - name: Generate test data
        run: poetry run python data/generate_delta_lake.py

      - name: Run unit tests
        run: |
          poetry run pytest tests/unit_tests/ -v --tb=short \
            --cov=module --cov=specs --cov=src --cov=data --cov=feature_store \
            --cov-report=xml --cov-report=term

      - name: Run integration tests
        run: |
          poetry run pytest tests/integration_tests/ -v --tb=short

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: tests
          fail_ci_if_error: false

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      - name: Check code formatting with black
        run: poetry run black --check .
        continue-on-error: true

      - name: Type checking with mypy
        run: poetry run mypy module/ specs/ src/ --ignore-missing-imports
        continue-on-error: true

  training:
    name: Test Training Application
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      - name: Generate test data
        run: poetry run python data/generate_delta_lake.py

      - name: Run training application
        run: poetry run python application_training.py

      - name: Verify MLflow artifacts
        run: |
          ls -la mlruns/ || echo "MLflow runs directory exists"
          poetry run python -c "
          import mlflow
          try:
              client = mlflow.tracking.MlflowClient()
              models = client.search_registered_models()
              print(f'âœ“ Registered models: {len(models)}')
          except Exception as e:
              print(f'Note: {e}')
          "

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t ml-workflow:latest .

      - name: Validate Docker Compose
        run: docker-compose config

